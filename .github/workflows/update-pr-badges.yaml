name: Update PR Count Badges

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-pr-badges.yaml'
      - 'registry.yaml'

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update PR count badges
        id: update-badges
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          set -e

          # Ensure badges directory exists
          mkdir -p badges

          # Read packages from registry.yaml
          # Extract name and repo for each package
          packages=$(yq e '.packages[] | .name + ":" + .repo' registry.yaml)

          echo "Found packages in registry:"
          echo "$packages"
          echo ""

          # Track if any files changed
          changes_made=false

          while IFS=: read -r pkg_name repo; do
            [ -z "$pkg_name" ] && continue

            echo "Processing $pkg_name (repo: $repo)..."

            # Get all open PRs for this repo
            pr_data=$(gh pr list \
              --repo "$repo" \
              --state open \
              --json isDraft \
              --limit 100 2>/dev/null || echo "[]")

            # Count draft and ready PRs
            draft_count=$(echo "$pr_data" | jq '[.[] | select(.isDraft == true)] | length')
            ready_count=$(echo "$pr_data" | jq '[.[] | select(.isDraft == false)] | length')

            # Update draft PR badge JSON (in badges/ directory)
            draft_file="badges/pr-draft-${pkg_name}.json"
            printf '{\n  "schemaVersion": 1,\n  "label": "draft",\n  "message": "%s",\n  "color": "yellow"\n}\n' "$draft_count" > "$draft_file"

            # Update ready PR badge JSON (in badges/ directory)
            ready_file="badges/pr-ready-${pkg_name}.json"
            printf '{\n  "schemaVersion": 1,\n  "label": "ready",\n  "message": "%s",\n  "color": "green"\n}\n' "$ready_count" > "$ready_file"

            echo "  Draft PRs: $draft_count, Ready PRs: $ready_count"

          done <<< "$packages"

          # Check if any files changed
          if [[ -n $(git status --porcelain) ]]; then
            changes_made=true
          fi

          echo "changes_made=$changes_made" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.update-badges.outputs.changes_made == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add badges/
          git commit -m "chore: update PR count badges [skip ci]"
          # Pull with rebase in case another workflow pushed (e.g., README generation)
          git pull --rebase origin main || true
          git push
